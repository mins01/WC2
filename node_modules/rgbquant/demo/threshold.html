<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Document</title>

	<script src="../src/rgbquant.js"></script>
</head>
<body>
	<img id="img" src="img/pool.png" alt="">
<!--<img id="img" src="SnOkhf1.jpg" alt="">-->
	<script>
		function roundIncr(num, incr) {
			return incr * Math.round(num/incr);
		}

		var img = document.getElementById("img"),
			can = document.createElement("canvas"),
			ctx = can.getContext("2d");

		can.width = img.naturalWidth;
		can.height = img.naturalHeight;

		ctx.drawImage(img,0,0);

		var imgd = ctx.getImageData(0,0,can.width,can.height),
		//	buf32 = new Uint32Array(imgd.data.buffer),
			pxls = imgd.data,
			len = pxls.length;

		console.time("threshold");
		var hist = {}, i32, r, g, b;
		for (var i = 0; i < len; i++) {
			imgd.data[i] = r = roundIncr(pxls[i++], 24);
			imgd.data[i] = g = roundIncr(pxls[i++], 24);
			imgd.data[i] = b = roundIncr(pxls[i++], 24);
//			imgd.data[i] = a = 255;

			i32 = (
				(255 << 24)	|	// alpha
				(b   << 16)	|	// blue
				(g   <<  8)	|	// green
				 r				// red
			) >>> 0;
/*
			// fast on ff
			if (i32 in hist)
				hist[i32]++;
			else
				hist[i32] = 1;
*/
			// fast on chrome
			hist[i32] = (hist[i32] || 0) + 1;
		}
		console.timeEnd("threshold");

		var q = new RgbQuant({colors: 32});
		q.histogram = hist;
		console.time("palette");
		var pal = q.palette();
		console.timeEnd("palette");

		console.time("reduce");
		var data = q.reduce(imgd);
		console.timeEnd("reduce");

		imgd.data.set(data);
		ctx.putImageData(imgd,0,0);


		document.body.appendChild(can);
	</script>
</body>
</html>